# メールサーバ構築手順
## 1. 各構成
### 仮想マシンの構成

- 仮想マシン名 ：`VM_MAIL`<br>
- メモリ ：`2048 MB`<br>
- 動的メモリ ：`チェックなし`<br>
- ネットワーク構成 ：`LabServiceSwitch`
- 仮想HDDサイズ ：`32GB`
- インストールオプション ：`ISOファイルを参照`
- プロセッサ数 ：`2`

### AlmaLinuxの構成

- OSバージョン ：`8.x`
- ホスト名 ：`mail.sub.site-n.local`
- IPアドレス ：`192.168.0.32`
- サブネットマスク ：`255.255.255.0`
- ゲートウェイ ：`192.168.0.1`
- DNS ：`ドメインコントローラのIPアドレス`
- 地域 ：`アジア`
- 都市 ：`東京`
- ネットワーク時刻 ：`オン`
- rootパスワード ：`AlmaLinux`
- ユーザ ：`testuser`
- パスワード ：`AlmaLinux`
- 高度なユーザ設定
    - グループメンバーシップ ：`wheel`
- 親ドメイン ：`site-n.local`<br>
<sub>Bindインストール後、サブドメイン追加</sub>

<dr style="color:red">**※Linuxインストール後、チェックポイントを取得**

<br>

## 2. 手順
### Bindのインストールとサブドメインの追加
#### 1. パッケージのインストールとnamed.comfの基本設定(1/2)

```
//Bindパッケージのインストール
$ sudo dnf install bind bind-chroot bind-utils
```
<br>


#### 2. named.confファイルのバックアップ
```
$ sudo cp /etc/named.conf /etc/named.conf.dif
```
<br>


#### 3. パッケージのインストールとnamed.comfの基本設定(2/2)

named.conf の基本設定
```
$ sudo vi /etc/named.conf
```

```shell
options {
        //listen-on port 53 { 127.0.0.1; };
        listen-on port 53 { 127.0.0.1; 192.168.0.32; };	  ←「192.168.0.32」を追加する
        //listen-on-v6 port 53 { ::1; };
        listen-on-v6 port 53 { none; };    ←「none;」に変更する
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
        secroots-file   "/var/named/data/named.secroots";
        recursing-file  "/var/named/data/named.recursing";
        //allow-query     { localhost; };
        allow-query     { any; };   ←「any;」に変更する

        /*
         - If you are building an AUTHORITATIVE DNS server, do NOT enable recursion.
         - If you are building a RECURSIVE (caching) DNS server, you need to enable
           recursion.
         - If your recursive DNS server has a public IP address, you MUST enable access
           control to limit queries to your legitimate users. Failing to do so will
           cause your server to become part of large scale DNS amplification
           attacks. Implementing BCP38 within your network would greatly
           reduce such attack surface
        */
        //recursion yes;
        recursion no;   ←「no」に変更する

～略～

zone "." IN {
        type hint;
        file "named.ca";
};

zone "sub.site-n.local" {             ← sub.site-n.localゾーンを追加
        type slave;
        file "sub.site-n.local.lan";
        masters { 192.168.0.21; };
	notify no;
};


include "/etc/named.rfc1912.zones";
include "/etc/named.root.key";
```
<br>


```
//設定ファイルの書式確認
$ sudo named-checkconf
```
<br>

#### 4. Bindの起動と確認

```
//Bindの起動
$ sudo systemctl start named-chroot
```
<br>

```
//Bindの状態確認
$ sudo systemctl status named-chroot
```
<br>


#### 5. 自動起動とファイアウォールの設定

```
//Bindの自動起動設定
$ sudo systemctl enable named-chroot
```
<br>

```
//ファイアウォールのサービス許可設定
$ sudo firewall-cmd --add-service=dns --zone=public --permanent
$ sudo firewall-cmd --reload
```
<br>


#### 6. 参照するDNSサーバの設定

設定ファイルの新規作成

```
//90-dns-none.confというファイルを新規作成
$ sudo vi /etc/NetworkManager/conf.d/90-dns-none.conf
```

```
//作成したファイルに下記のように入力
[main]
dns=none
```
<br>

/etc/resolv.confの編集

```
$ sudo vi /etc/resolv.conf
```

```shell
# Generated by NetworkManager
search sub.site-n.local
nameserver 192.168.0.22
nameserver 192.168.0.21    ←「192.168.0.21」を追加
nameserver 192.168.0.32    ←「192.168.0.32」を追加
```

```
//NetWorkManagerサービスの再読み込み
$ sudo systemctl reload NetworkManager
```
<br>

#### 7. Subドメインのゾーンファイル作成
※プライマリサーバ(192.168.0.21)側の操作

ゾーンファイルの編集

```
$ sudo vi /var/named/sub.site-n.local.lan
```
<br>

```shell
$TTL 3H                                                                      ←sub.site-n.local.lanを左の通りに修正する
$ORIGIN sub.site-n.local.
@       IN SOA  alma root (
                                        2025062601      ; serial             ←シリアルナンバーを更新
                                        1D      ; refresh
                                        1H      ; retry
                                        1W      ; expire
                                        3H )    ; minimum
        NS      ns.sub.site-n.local.
        MX 10   mail.sub.site-n.local.

alma A 192.168.0.21
ns A 192.168.0.21
www A 192.168.0.21
mail A 192.168.0.32
ns A 192.168.0.32

〇named.confを修正する
　$ sudo vi /etc/named.conf

zone "sub.site-n.local" {                               ←「zone "sub.site-n.local"」の部分を修正する
        type master;
        file "sub.site-n.local.lan";
        allow-update { none; };
        allow-transfer { 192.168.0.32; };
};
```
<br>

#### 8. 設定ファイルとゾーンファイルの書式設定

```
//named-checkコマンドでの書式チェック
$ sudo named-checkconf
```

```
//named-checkzoneコマンドでの書式チェック
$ sudo named-checkzone sub.site-n.local. /var/named/sub.site-n.local.lan
```

```
//NetWorkManagerサービスの再読み込み
$ sudo systemctl reload NetworkManager
```

#### 9. 名前解決の確認(1/3)

```
//digコマンドによる名前解決確認
$ dig test.sub.site-n.local
```
