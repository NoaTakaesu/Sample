# メールサーバ構築手順
## 1. 各構成
### 仮想マシンの構成

- 仮想マシン名 ：`VM_MAIL`<br>
- メモリ ：`2048 MB`<br>
- 動的メモリ ：`チェックなし`<br>
- ネットワーク構成 ：`LabServiceSwitch`
- 仮想HDDサイズ ：`32GB`
- インストールオプション ：`ISOファイルを参照`
- プロセッサ数 ：`2`

### AlmaLinuxの構成

- OSバージョン ：`8.x`
- ホスト名 ：`mail.sub.site-n.local`
- IPアドレス ：`192.168.0.32`
- サブネットマスク ：`255.255.255.0`
- ゲートウェイ ：`192.168.0.1`
- DNS ：`ドメインコントローラのIPアドレス`
- 地域 ：`アジア`
- 都市 ：`東京`
- ネットワーク時刻 ：`オン`
- rootパスワード ：`AlmaLinux`
- ユーザ ：`testuser`
- パスワード ：`AlmaLinux`
- 高度なユーザ設定
    - グループメンバーシップ ：`wheel`
- 親ドメイン ：`site-n.local`<br>
<sub>Bindインストール後、サブドメイン追加</sub>

<dr style="color:red">**※Linuxインストール後、チェックポイントを取得**

<br>

## 2. 手順
### Bindのインストールとサブドメインの追加
#### 1. パッケージのインストールとnamed.comfの基本設定(1/2)

```
//Bindパッケージのインストール
$ sudo dnf install bind bind-chroot bind-utils
```
<br>


#### 2. named.confファイルのバックアップ

```
$ sudo cp /etc/named.conf /etc/named.conf.dif
```
<br>


#### 3. パッケージのインストールとnamed.comfの基本設定(2/2)

named.conf の基本設定
```
$ sudo vi /etc/named.conf
```

```shell
options {
        //listen-on port 53 { 127.0.0.1; };
        listen-on port 53 { 127.0.0.1; 192.168.0.32; };	  ←「192.168.0.32」を追加する
        //listen-on-v6 port 53 { ::1; };
        listen-on-v6 port 53 { none; };    ←「none;」に変更する
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
        secroots-file   "/var/named/data/named.secroots";
        recursing-file  "/var/named/data/named.recursing";
        //allow-query     { localhost; };
        allow-query     { any; };   ←「any;」に変更する

        /*
         - If you are building an AUTHORITATIVE DNS server, do NOT enable recursion.
         - If you are building a RECURSIVE (caching) DNS server, you need to enable
           recursion.
         - If your recursive DNS server has a public IP address, you MUST enable access
           control to limit queries to your legitimate users. Failing to do so will
           cause your server to become part of large scale DNS amplification
           attacks. Implementing BCP38 within your network would greatly
           reduce such attack surface
        */
        //recursion yes;
        recursion no;   ←「no」に変更する

～略～

zone "." IN {
        type hint;
        file "named.ca";
};

zone "sub.site-n.local" {             ← sub.site-n.localゾーンを追加
        type slave;
        file "sub.site-n.local.lan";
        masters { 192.168.0.21; };
	notify no;
};


include "/etc/named.rfc1912.zones";
include "/etc/named.root.key";
```
<br>


```
//設定ファイルの書式確認
$ sudo named-checkconf
```
<br>

#### 4. Bindの起動と確認

```
//Bindの起動
$ sudo systemctl start named-chroot
```
<br>

```
//Bindの状態確認
$ sudo systemctl status named-chroot
```
<br>


#### 5. 自動起動とファイアウォールの設定

```
//Bindの自動起動設定
$ sudo systemctl enable named-chroot
```
<br>

```
//ファイアウォールのサービス許可設定
$ sudo firewall-cmd --add-service=dns --zone=public --permanent
$ sudo firewall-cmd --reload
```
<br>


#### 6. 参照するDNSサーバの設定

設定ファイルの新規作成

```
//90-dns-none.confというファイルを新規作成
$ sudo vi /etc/NetworkManager/conf.d/90-dns-none.conf
```

```
//作成したファイルに下記のように入力
[main]
dns=none
```
<br>

/etc/resolv.confの編集

```
$ sudo vi /etc/resolv.conf
```

```shell
# Generated by NetworkManager
search sub.site-n.local
nameserver 192.168.0.22
nameserver 192.168.0.21    ←「192.168.0.21」を追加
nameserver 192.168.0.32    ←「192.168.0.32」を追加
```

```
//NetWorkManagerサービスの再読み込み
$ sudo systemctl reload NetworkManager
```
<br>

#### 7. Subドメインのゾーンファイル作成
※プライマリサーバ(192.168.0.21)側の操作

ゾーンファイルの編集

```
$ sudo vi /var/named/sub.site-n.local.lan
```


```shell
$TTL 3H                                                                      ←sub.site-n.local.lanを左の通りに修正する
$ORIGIN sub.site-n.local.
@       IN SOA  alma root (
                                        2025062601      ; serial             ←シリアルナンバーを更新
                                        1D      ; refresh
                                        1H      ; retry
                                        1W      ; expire
                                        3H )    ; minimum
        NS      ns.sub.site-n.local.
        MX 10   mail.sub.site-n.local.

alma A 192.168.0.21
ns A 192.168.0.21
www A 192.168.0.21
mail A 192.168.0.32
ns A 192.168.0.32
```
<br>

named.confを修正する
```
　$ sudo vi /etc/named.conf
```

```
zone "sub.site-n.local" {                               ←「zone "sub.site-n.local"」の部分を修正する
        type master;
        file "sub.site-n.local.lan";
        allow-update { none; };
        allow-transfer { 192.168.0.32; };
};
```
<br>


#### 8. 設定ファイルとゾーンファイルの書式設定

```
//named-checkコマンドでの書式チェック
$ sudo named-checkconf
```

```
//named-checkzoneコマンドでの書式チェック
$ sudo named-checkzone sub.site-n.local. /var/named/sub.site-n.local.lan
```

```
//NetWorkManagerサービスの再読み込み
$ sudo systemctl reload NetworkManager
```
<br>


#### 9. 名前解決の確認(1/3)

```
//digコマンドによる名前解決確認
$ dig test.sub.site-n.local
```
<br>


#### 10. 名前解決の確認(2/3)

digコマンドによる名前解決確認

画像:Windowsクライアントでの名前解決①

<br>


#### 11. ドメインコントローラのDNSにサブドメインを追加
ADコントローラのWindowsサーバにサブドメインを追加する

<br>


#### 12. 名前解決の確認(3/3)
Windowsクライアントから名前解決が正常に行われるかを確認
(画像挿入：Windowsクライアントでの名前解決②)

<br>

### メールサーバの構築
#### 1. cyrus-saslをインストールする

```
$ dnf install -y cyrus-sasl
```

<br>

起動・自動起動の設定をする

```
$ systemctl start saslauthd
$ systemctl enable saslauthd
```

<br>


#### 2. cyrus-sasl-plainをインストールする

```
$ dnf install cyrus-sasl-plain
```

<br>


#### 3. smtpd.conf を編集する

```
$ vi /etc/sasl2/smtpd.conf
```

```
pwcheck_method: auxprop     ← 左の通り入力する
mech_list: plain login
```

<br>


#### 4. postfixをインストールする

```
$ dnf install -y postfix
```

<br>


#### 5. postfixを起動する

```
$ postfix start
```

<br>


#### 6. main.cfのバックアップを作成する

```
$ cp /etc/postfix/main.cf /etc/postfix/main.cf.dif
```

<br>


#### 7. main.cfを編集する

```
$ vi /etc/postfix/main.cf
```

```shell
(修正前)                             (修正後)
#inet_interfaces = all    →     inet_interfaces = all
inet_interfaces = localhost    →    #inet_interfaces = localhost
#myhostname = host.domain.tld    →    myhostname = mail.sub.site-n.local
#mydomain = domain.tld    →    mydomain = mail.sub.site-n.local
#myorigin = $mydomain    →    myorigin = $mydomain
#home_mailbox = Maildir/    →    home_mailbox = Maildir/
#mynetworks = 168.100.189.0/28, 127.0.0.0/8    →    mynetworks = 192.168.0.0/24, 127.0.0.0/8
     【追加】               →    smtpd_sasl_auth_enable = yes
     【追加】               →    smtpd_recipient_restrictions =
     　　　　               　    	permit_mynetworks
     　　　　               　    	permit_sasl_authenticated
     　　　　               　    	reject_unauth_destination
     【追加】               →    smtp_sasl_auth_enable = yes
     【追加】               →    smtp_sasl_password_maps = hash:/etc/postfix/smtp_pass
     【追加】               →    smtp_sasl_tls_security_options = noanonymous
     【追加】               →    smtp_sasl_mechanism_filter = plain,login
#relayhost = [gateway.my.domain]    →    relayhost = [mail.sub.site-n.local]:587
```


```
//main.cfの文法が正しいかを確認する
$ postfix check
```

<br>


#### 8. 認証情報ファイルの作成

```
$ vi /etc/postfix/smtp_pass
```

```
[mail.sub.site-n.local]:587 mailuser:AlmaLinux
```

```
$ chmod 600 /etc/postfix/smtp_pass
```

<br>


#### 9. 認証ファイルhash化

```
$ postmap /etc/postfix/smtp_pass
```

<br>


#### 10. ポート587番を有効化する

```
$ vi /etc/postfix/master.cf
```

```
(修正前)submission inet n    -    n    -    -    smtpd              
(修正後)submission inet n    -    n    -    -    smtpd
```

```
//postfixを再起動する
postfix reload
```

<br>


#### 11. メール送信で使うポートを許可する

```
$ firewall-cmd --add-service=smtp --permanent
```

<br>


#### 12. ポート587番を開放する

```
$ firewall-cmd --add-port=587/tcp --zone=public --permanent
```

<br>


#### 13. ポート25番を開放する

```
$ firewall-cmd --add-port=25/tcp --zone=public --permanent
```

<br>


#### 14. ファイアウォールの設定を有効化する

```
$ firewall-cmd --reload
```

<br>


#### 15. メールユーザの追加

```
//sitenuserを追加する
$ useradd -s /sbin/nologin sitenuser
```

```
//パスワード設定
$ passwd sitenuser

パスワード：AlmaLinux
```

```
//Authユーザーを設定する
$ echo "AlmaLinux" | saslpasswd2 -p -u mail.sub.site-n.local -c sitenuser
```

```
//abcを追加する
$ useradd -s /sbin/nologin abc
```

```
//パスワード設定
$ passwd abc

パスワード：AlmaLinux
```

```
//Authユーザーを設定する
$ echo "AlmaLinux" | saslpasswd2 -p -u mail.sub.site-n.local -c abc
```

```
//ユーザーの登録を確認する
$ sasldblistusers2
```

```
//権限変更する
$ chgrp postfix /etc/sasldb2
```

<br>

#### 16. aliases.dbを作成する

```
$ newaliases
```

<br>


#### 17. postfixを再起動する

```
$ postfix reload
```

